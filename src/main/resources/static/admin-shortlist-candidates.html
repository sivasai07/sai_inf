<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>shortlist Athletes</title>
  <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <style>
    :root {
--primary-color: #0077be;
--secondary-color: #00a86b;
--background-dark: #121212;
--text-light: #f4f4f4;
--gradient-primary: linear-gradient(135deg, #0077be 0%, #00a86b 100%);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Poppins', sans-serif;
}
body {
font-family: Arial, sans-serif;
margin: 0;
padding: 0;
background: rgb(16,16,18);
background: linear-gradient(108deg, rgba(16,16,18,1) 0%, rgba(1,28,55,1) 100%);
background-size: cover;
color: #333;
}

.event-text{
margin: 40px;
max-width: 400%;
font-size: 100px;
padding: 10px;
font-size: large;
text-align: center;
color: white;
}
/* Custom Navbar Styling */
nav {
        background: rgba(0, 0, 0, 0.9);
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    nav .brand {
        font-size: 1.5rem;
        font-weight: bold;
        color: #ffa500;
    }

    nav .nav-links a {
        text-decoration: none;
        margin: 0 15px;
        color: #ffffff;
        transition: color 0.3s ease;
    }

    nav .nav-links a:hover {
        color: #ffa500;
    }

    nav .nav-links a.active {
        font-weight: bold;
    }
      .navbar {
    color: white;
    background-color: rgba(18, 18, 18, 0.9);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1000;
    transition: background-color 0.3s ease;
    backdrop-filter: blur(10px);
}
.nav-links {
    display: flex;
    list-style: none;
    gap: 20px;
    margin-right: 40px;

}

.nav-links li {
    position: relative;
}

.nav-links a {
    color: var(--text-light);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
    padding-bottom: 5px;
}

.nav-links a::after {
    content: '';
    position: absolute;
    width: 0;
    height: 2px;
    bottom: 0;
    left: 0;
    background: var(--gradient-primary);
    transition: width 0.3s ease;
}

.nav-links a:hover::after {
    width: 100%;
}

.nav-links a:hover {
    color: var(--secondary-color);
    transform: translateY(-3px);
}

.logo {
    color: var(--text-light);
    font-size: 1.8rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 2px;
}


.dropdown {
    position: relative;
    left: -4em;
    margin-left: 40px;
    margin-right:-60px ;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: rgba(30, 30, 30, 0.9);
    min-width: 200px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    z-index: 1;
    top: 100%;
    left: 0;
    border-radius: 8px;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.dropdown:hover .dropdown-content {
    display: block;
    animation: dropdownSlideIn 0.3s ease;
}

.dropdown-content a {
    color: var(--text-light);
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    transition: background-color 0.3s ease;
}

.dropdown-content a:hover {
    background-color: rgba(50, 50, 50, 0.9);
    color: var(--secondary-color);
}
@keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            .hero-content h1 { font-size: 2.5rem; }
            .hero-content p { font-size: 1.2rem; }
        }/* Overlay for better readability */
    .overlay{
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -1;
    }
h1 {
  color: #ffa500;
  text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.7);
}

table {
  border-radius: 10px;
}

table th {
  background-color: #ffa500;
  color: black;
}

#event-list .event-card {
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  background-color: rgba(0, 0, 0, 0.8);
  padding: 20px;
  margin-bottom: 20px;
  color: #ffffff;
  transition: transform 0.3s ease;
}

#event-list .event-card:hover {
  transform: translateY(-5px);
  background-color: rgba(255, 255, 255, 0.1);
}

.btn-right {
  position: absolute;
  right: 20px;
  top: 20px;
}


h1, h3 {
  color: #ffffff;
}

.event-card {
  background-color: #343a40;
  border: 1px solid #ffffff;
  border-radius: 8px;
  color: #ffffff;
}

.event-card h4 {
  margin-bottom: 8px;
}

.event-card button {
  margin-top: 8px;
}

#athlete-list table {
  width: 100%;
}

.accepted-row {
  background-color: #d4edda !important; /* Green for accepted */
}

.declined-row {
  background-color: #f8d7da !important; /* Red for declined */
}
.accepted-row {
  background-color: green; /* Light green for accepted */
}

.declined-row {
  background-color: red; /* Light red for declined */
}

.registered-row {
  background-color: #fff; /* White or default color for registered */
}


.modal-header, .modal-content {
  background-color: #343a40;
  color: #ffffff;
}
.modal-body {
  color: #ffffff;
}
#athlete-counts {
  display: flex;
  justify-content: space-between;
  background-color: #fff; /* White box background */
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  max-width: 600px; /* Adjust width as needed */
  margin-bottom: 20px;
}

#athlete-counts span {
  font-weight: bold;
  color: black; /* Default text color */
  padding: 5px 10px;
  border-radius: 3px;
}

#accepted-count {
  background-color: #28a745; /* Green for accepted */
}

#registered-count {
  background-color: #ffc107; /* Yellow for registered */
}

#declined-count {
  background-color: #dc3545; /* Red for declined */
}

#athlete-counts span:hover {
  opacity: 0.8; /* Hover effect to lighten the color */
}
label {
  font-weight: bold;
  margin-right: 10px;
}

/* Green label for Max Accepted */
#max-accepted-label {
  color: #28a745; /* Green for accepted */
}

  </style>
</head>
<body>
<!-- Background Overlay -->
<div class="overlay"></div>

<!-- Navbar -->
<nav>
  <div class="brand">Admin</div>
  <div class="nav-links">
      <a href="admindasboard.html">Home</a>
      <a href="admin-news.html">News</a>
      <br>
     
      <li class="dropdown">
          <a href="#events">Events</a>
          <div class="dropdown-content">
              <a href="admin-upcomingevents.html">Upcoming Events</a>
              <a href="admin-ongoingevents.html">Ongoing Events</a>
              <a href="admin-Allpast-events.html">Past Events</a>
          </div>
      </li>     
     <a href="admin-Resultss.html">Results</a>
      <a href="admin-coaches.html">Coaches</a>
      <a href="adminathletes.html">Athletes</a>
      <a href="AdminProfile.html">Profile</a>
      <li><a href="index.html" id="logoutlink" onclick="logout()">Logout</a></li>
    </div>
</nav>
<div class="container mt-5">
  <h1 class="text-center">Event Registration Management</h1>
  
  <div id="event-list" class="mt-4"></div>

  <div id="athlete-list" class="mt-5 d-none">
    <div class="d-flex justify-content-between align-items-center">
      <h3>Registered Athletes</h3>
      <div>
        <div id="athlete-counts" class="mb-3">
          <span>Accepted: <span id="accepted-count">0</span></span> | 
          <span>Pending Request: <span id="registered-count">0</span></span> | 
          <span>Declined: <span id="declined-count">0</span></span>
        </div>
        <label for="max-accepted" id="max-accepted-label" class="me-2">Max Accepted:</label>
        <input type="number" id="max-accepted" value="25" />
              </div>
    </div>
    <table class="table table-dark table-striped mt-3">
      <thead>
        <tr>
          <th scope="col">S.No</th>
          <th scope="col">Athlete ID</th>
          <th scope="col">Name</th>
          <th scope="col">Category</th>
          <th scope="col">Status</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody id="athlete-table-body"></tbody>
    </table>
    <div class="modal fade" id="athleteDetailsModal" tabindex="-1" aria-labelledby="athleteDetailsLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="athleteDetailsLabel">Athlete Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><strong>Athlete ID:</strong> <span id="athlete-id"></span></p>
            <p><strong>Username:</strong> <span id="athlete-username"></span></p>
            <p><strong>First Name:</strong> <span id="athlete-first-name"></span></p>
            <p><strong>Last Name:</strong> <span id="athlete-last-name"></span></p>
            <p><strong>Birth Date:</strong> <span id="athlete-birth-date"></span></p>
            <p><strong>Gender:</strong> <span id="athlete-gender"></span></p>
            <p><strong>Height:</strong> <span id="athlete-height"></span></p>
            <p><strong>Weight:</strong> <span id="athlete-weight"></span></p>
            <p><strong>Category:</strong> <span id="athlete-category"></span></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <button id="back-to-events" class="btn btn-secondary mt-3">Back to Events</button>
  </div>
</div>

<script src="tokens.js"></script>

<script>
 
// Logout function
let sessionCheckInterval; // Variable to store the interval

// Enhanced logout function
function logout() {
    // Clear all storage
    localStorage.clear();
    sessionStorage.clear();
    
    // Clear the interval if it exists
    if (sessionCheckInterval) {
        clearInterval(sessionCheckInterval);
    }
    
    // Redirect to login page
    window.location.href = 'index.html';
}

// Function to check session validity
function checkSession() {
    const username = localStorage.getItem("username");
    if (!username) {
        console.log("Session invalid: Username not found");
        logout();
    }
}


  const apiUrl = "http://127.0.0.1:8080/api/events";
const athleteApiUrl = "http://127.0.0.1:8080/api/athletes";

document.addEventListener("DOMContentLoaded", () => {
  fetchEvents();
});

// Fetch events
async function fetchEvents() {
  try {
    const response = await fetch(`${apiUrl}/list`);
    if (!response.ok) throw new Error("Failed to fetch events");

    const events = await response.json();
    const eventList = document.getElementById("event-list");
    eventList.innerHTML = "";

    events.forEach(event => {
      const eventCard = document.createElement("div");
      eventCard.className = "event-card p-3 mb-3";

      eventCard.innerHTML = `
        <h4>${event.eventTitle}</h4>
        <p><strong>Date:</strong> ${event.eventDate}</p>
        <p><strong>Time:</strong> ${event.eventTime}</p>
        <p><strong>Location:</strong> ${event.eventLocation}</p>
        <button class="btn btn-success" onclick="viewAthletes(${event.eventId})">View Athletes</button>
      `;
      eventList.appendChild(eventCard);
    });
  } catch (error) {
    console.error("Error fetching events:", error);
  }
}

async function viewAthletes(eventId) {
  try {
    const response = await fetch(`${apiUrl}/details/${eventId}`);
    if (!response.ok) throw new Error("Failed to fetch event details");

    const event = await response.json();
    const athleteTableBody = document.getElementById("athlete-table-body");
    athleteTableBody.innerHTML = "";

    const athletes = await Promise.all((event.registeredAthletes || []).map(fetchAthleteDetails));
    const acceptedAthletes = [];
    const declinedAthletes = [];
    const registeredAthletes = [];

    // Categorize athletes based on their status
    athletes.forEach(athlete => {
      const status = event.acceptedAthletes.includes(athlete.id) ? "Accepted"
                   : event.declinedAthletes.includes(athlete.id) ? "Declined"
                   : "Registered";

      athlete.status = status; // Add status dynamically for sorting later
      if (status === "Accepted") {
        acceptedAthletes.push(athlete);
      } else if (status === "Declined") {
        declinedAthletes.push(athlete);
      } else {
        registeredAthletes.push(athlete);
      }
    });

    // Update athlete counts
    document.getElementById("accepted-count").textContent = acceptedAthletes.length;
    document.getElementById("registered-count").textContent = registeredAthletes.length;
    document.getElementById("declined-count").textContent = declinedAthletes.length;

    // Merge sorted groups: Accepted, Registered, Declined
    const sortedAthletes = [...acceptedAthletes, ...registeredAthletes, ...declinedAthletes];

    // Populate table with athletes
    sortedAthletes.forEach((athlete, index) => {
      // Determine the class based on athlete status
      const rowClass = athlete.status === "Accepted" ? "accepted-row"
                     : athlete.status === "Declined" ? "declined-row"
                     : "registered-row";

      const isAccepted = athlete.status === "Accepted";
      const isDeclined = athlete.status === "Declined";

      athleteTableBody.innerHTML += `
        <tr class="${rowClass}">
          <td>${index + 1}</td>
          <td>${athlete.id}</td>
          <td>${athlete.username}</td>
          <td>${athlete.category}</td>
          <td>${athlete.status}</td>
          <td>
            <button class="btn btn-info btn-sm" onclick="viewAthleteDetails(${athlete.id})">View Details</button>
            <button class="btn btn-success btn-sm" onclick="acceptRegistration(${athlete.id}, ${eventId})" ${isAccepted || isDeclined ? 'disabled' : ''}>Accept</button>
            <button class="btn btn-danger btn-sm" onclick="declineRegistration(${athlete.id}, ${eventId})" ${isDeclined || isAccepted ? 'disabled' : ''}>Reject</button>
          </td>
        </tr>
      `;
    });

    document.getElementById("event-list").classList.add("d-none");
    document.getElementById("athlete-list").classList.remove("d-none");
  } catch (error) {
    console.error("Error fetching athletes:", error);
  }
}

// Fetch athlete details
async function fetchAthleteDetails(athleteId) {
  try {
    const response = await fetch(`${athleteApiUrl}/${athleteId}`);
    if (!response.ok) throw new Error("Failed to fetch athlete details");
    return await response.json();
  } catch (error) {
    console.error(error);
    return null;
  }
}

// Send notifications
async function sendNotification(athleteId, message) {
  try {
    const response = await fetch(`http://127.0.0.1:8080/api/notifications/send`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        athleteId: athleteId,
        message: message,
      }),
    });

    if (!response.ok) {
      console.error("Failed to send notification:", await response.text());
    }
  } catch (error) {
    console.error("Error sending notification:", error);
  }
}

// Accept athlete registration
async function acceptRegistration(athleteId, eventId) {
  try {
    const maxAccepted = parseInt(document.getElementById("max-accepted").value);
    const acceptedCount = document.querySelectorAll(".accepted-row").length;

    if (acceptedCount >= maxAccepted) {
      alert("Cannot accept more athletes. Max limit reached.");
      return;
    }

    // Send accept request to the server
    const response = await fetch(`${apiUrl}/${eventId}/athlete/${athleteId}/accept`, { method: "POST" });

    if (response.ok) {
      // Notify athlete of acceptance
      await sendNotification(athleteId, `Congratulations, your registration has been ACCEPTED for event ID: ${eventId}`);

      // Refresh the athlete view
      viewAthletes(eventId);
    } else {
      alert("Failed to accept registration.");
    }
  } catch (error) {
    console.error("Error accepting registration:", error);
  }
}

// Decline athlete registration
async function declineRegistration(athleteId, eventId) {
  try {
    // Send decline request to the server
    const response = await fetch(`${apiUrl}/${eventId}/athlete/${athleteId}/decline`, { method: "POST" });

    if (response.ok) {
      // Notify athlete of decline
      await sendNotification(athleteId, `Sorry, your registration has been DECLINED for event ID: ${eventId}`);

      // Refresh the athlete view
      viewAthletes(eventId);
    } else {
      alert("Failed to decline registration.");
    }
  } catch (error) {
    console.error("Error declining registration:", error);
  }
}

// View athlete details in a modal
async function viewAthleteDetails(athleteId) {
  try {
    const response = await fetch(`${athleteApiUrl}/${athleteId}`);
    if (!response.ok) throw new Error("Failed to fetch athlete details");

    const athlete = await response.json();

    document.getElementById("athlete-id").textContent = athlete.id || "N/A";
    document.getElementById("athlete-username").textContent = athlete.username || "N/A";
    document.getElementById("athlete-first-name").textContent = athlete.firstName || "N/A";
    document.getElementById("athlete-last-name").textContent = athlete.lastName || "N/A";
    document.getElementById("athlete-birth-date").textContent = athlete.birthDate || "N/A";
    document.getElementById("athlete-gender").textContent = athlete.gender || "N/A";
    document.getElementById("athlete-height").textContent = athlete.height ? `${athlete.height} cm` : "N/A";
    document.getElementById("athlete-weight").textContent = athlete.weight ? `${athlete.weight} kg` : "N/A";
    document.getElementById("athlete-category").textContent = athlete.category || "N/A";

    const modal = new bootstrap.Modal(document.getElementById("athleteDetailsModal"));
    modal.show();
  } catch (error) {
    console.error("Error fetching athlete details:", error);
  }
}

// Back to events view
document.getElementById("back-to-events").addEventListener("click", () => {
  document.getElementById("event-list").classList.remove("d-none");
  document.getElementById("athlete-list").classList.add("d-none");
  document.getElementById("athlete-table-body").innerHTML = "";
});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
